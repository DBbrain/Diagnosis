##赛题解析

####一、更新语句
#####1. 优化思路
对这一个常见的更新语句，我们首先想到的是利用好mysql在semijoin上的优化能力。不少参赛者将其改成如下形式，性能会变得更差。这种方式导致semijoin失效，聚合查询dependent subquery被执行多次。

```sql
update `order` set
create_time = now()
where id in (
    select distinct(parent) from order_item where type = 2
)
```

其次是要根据实际数据量的大小判断是否有必要将其改写成join，以便更改驱动顺序，但前提是要估计好子查询聚合带来的性能开销。在这里我们可以利用好合适的索引将这一开销减小到最小。创建索引时首先要注意到order_item表中字段type的定义为varchar，但是SQL语句中的条件值却是整数，类型不匹配会导致该条件隐式转换；其次最好创建组合索引，以便 "Using index for group-by"。

#####2. DBbrain优化方案
2.1）增加索引
```sql
alter table `order_itme` add index idx_1(type,parent);
```
2.2）SQL改写
```sql
update `order` o inner join (
   select type, parent from `order_item` where type = '2' group by type, parent
) i on o.id = i.parent set create_time = now();
```

####3. 优化效果
&nbsp;&nbsp;&nbsp;&nbsp;3.1）执行时间：毫秒级<br/>
&nbsp;&nbsp;&nbsp;&nbsp;3.2）参考执行计划
```sql

-+-----+------------+-----------+-----------+------+---------------+-------------+----------+-----------------------------+------+----------+--------------------------+-
 |id   |select_type | table     | partition | type | possible_keys | key         | key_len  | ref                         | rows | filtered | Extre                    |
-+-----+------------+-----------+-----------+------+---------------+-------------+----------+-----------------------------+------+----------+--------------------------+-
 |1    | UPDATE     | o         | NULL      | ALL  | PRIMARY       | NULL        | NULL     | NULL                        |  1   | 100.00   | NULL                     |
-+-----+------------+-----------+-----------+------+---------------+-------------+----------+-----------------------------+------+----------+--------------------------+-
 |1    | PRIMARY    | <derived> | NULL      | ref  | <auto_key0>   | <auto_key0> | 8        | sql_optimization_match.o.id |  2   | 100.00   | NULL                     |
-+-----+------------+-----------+-----------+------+---------------+-------------+----------+-----------------------------+------+----------+--------------------------+-
 |2    | DERIVED    | order_item | NULL     | ref  | idx_1         | idx_1       | 38       | const                       |  1   | 100.00   | Using where; Using index |
-+-----+------------+-----------+-----------+------+---------------+-------------+----------+-----------------------------+------+----------+--------------------------+-
```

####二、查询语句
#####1. 优化思路
参赛者反馈该SQL的数据模型存在很大问题，有无从下手的感觉。但是该SQL语句来自一个实际用户的业务场景。开发同学有他建立这一数据模型的理由，找DBA帮忙也是希望我们能以最小代价快速的出效果。这个时候DBA的现场结合业务场景应变能力就很重要。status只有两种状态，通过一个unin all就可以将混合排序简单化解。除此之外，需要利用好索引的排序能力

#####2. DBbrain优化方案

2.1）增加索引
```sql
alter table order_item add index `item_idx_1` (`update_time`,`parent`);
```
2.2）SQL改写
```sql
SELECT o.*,i.*
FROM   (
         (SELECT o.id,
            i.id item_id
       FROM   `order` o
            INNER JOIN order_item i
                     ON i.parent =o.id
          WHERE  o.status = 0
          ORDER  BY i.update_time DESC
          LIMIT  0, 20)
          UNION ALL
          (SELECT o.id,
             i.id item_id
          FROM   `order` o
            INNER JOIN order_item i
                    ON i.parent =o.id
          WHERE  o.status = 1
          ORDER  BY i.update_time DESC
          LIMIT  0, 20)
        ) tmp
       INNER JOIN `order` o ON tmp.id = o.id
       INNER JOIN order_item i ON tmp.item_id =i.id
ORDER  BY o.status ASC,
          i.update_time DESC
LIMIT  0, 20
```

####3. 优化效果
&nbsp;&nbsp;&nbsp;&nbsp;3.1）执行时间：毫秒级<br/>
&nbsp;&nbsp;&nbsp;&nbsp;3.2）参考执行计划
```sql
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |id   |select_type | table     | partition | type    | possible_keys | key         | key_len  | ref                             | rows | filtered | Extre                           |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |1    | PRIMARY    | <derived2>| NULL      | ALL     | NULL          | NULL        | NULL     | NULL                            |  40  | 100.00   | Using temporary; Using filesort |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |1    | PRIMARY    | o         | NULL      | eq_ref  | PRIMARY       | PRIMARY     | 8        | tmp.id                          |  1   | 100.00   | NULL                            |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |1    | PRIMARY    | i         | NULL      | eq_ref  | PRIMARY       | PRIMARY     | 8        | tmp.item_id                     |  1   | 100.00   | NULL                            |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |2    | DERIVED    | i         | NULL      | index   | NULL          | item_idx_1  | 12       | NULL                            |  20  | 100.00   | Using index                     |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |2    | DERIVED    | o         | NULL      | eq_ref  | PRIMARY       | PRIMARY     | 8        | sql_optimization_match.i.parent |  1   | 10.00    | Using where                     |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |3    | UNION      | i         | NULL      | index   | NULL          | item_idx_1  | 12       | NULL                            |  20  | 100.00   | Using index                     |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-
 |3    | UNION      | o         | NULL      | eq_ref  | PRIMARY       | PRIMARY     | 8        | sql_optimization_match.i.parent |  1   | 10.00    | Using where                     |
-+-----+------------+-----------+-----------+---------+---------------+-------------+----------+---------------------------------+------+----------+---------------------------------+-


```